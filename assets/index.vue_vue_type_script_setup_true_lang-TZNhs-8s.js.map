{"version":3,"file":"index.vue_vue_type_script_setup_true_lang-TZNhs-8s.js","sources":["../../src/layouts/components/Menu/index.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport type { MenuInjection, MenuProps } from './types'\nimport Item from './item.vue'\nimport SubMenu from './sub.vue'\nimport { rootMenuInjectionKey } from './types'\n\ndefineOptions({\n  name: 'MainMenu',\n})\n\nconst props = withDefaults(\n  defineProps<MenuProps>(),\n  {\n    accordion: true,\n    defaultOpeneds: () => [],\n    alwaysOpeneds: () => [],\n    mode: 'vertical',\n    collapse: false,\n    showCollapseName: false,\n    rounded: false,\n    direction: 'ltr',\n  },\n)\n\nconst activeIndex = ref<MenuInjection['activeIndex']>(props.value)\nconst items = ref<MenuInjection['items']>({})\nconst subMenus = ref<MenuInjection['subMenus']>({})\n// 合并 alwaysOpeneds 和 defaultOpeneds 并去重\nconst openedMenus = ref<MenuInjection['openedMenus']>(Array.from(new Set([...props.alwaysOpeneds.slice(0), ...props.defaultOpeneds.slice(0)])))\nconst alwaysOpenedsMenus = ref<MenuInjection['alwaysOpenedsMenus']>(props.alwaysOpeneds.slice(0))\nconst mouseInMenu = ref<MenuInjection['mouseInMenu']>([])\nconst isMenuPopup = computed<MenuInjection['isMenuPopup']>(() => {\n  return props.mode === 'horizontal' || (props.mode === 'vertical' && props.collapse)\n})\n\n// 解析传入的 menu 数据，并保存到 items 和 subMenus 对象中\nfunction initItems(menu: MenuProps['menu'], parentPaths: string[] = []) {\n  menu.forEach((item) => {\n    const index = item.path ?? JSON.stringify(item)\n    if (item.children) {\n      const indexPath = [...parentPaths, index]\n      subMenus.value[index] = {\n        index,\n        indexPath,\n        active: false,\n      }\n      initItems(item.children, indexPath)\n    }\n    else {\n      items.value[index] = {\n        index,\n        indexPath: parentPaths,\n      }\n    }\n  })\n}\n\nconst openMenu: MenuInjection['openMenu'] = (index, indexPath) => {\n  if (openedMenus.value.includes(index)) {\n    return\n  }\n  if (props.accordion) {\n    openedMenus.value = openedMenus.value.filter(key => indexPath.includes(key) || alwaysOpenedsMenus.value.includes(key))\n  }\n  openedMenus.value.push(index)\n}\nconst closeMenu: MenuInjection['closeMenu'] = (index) => {\n  if (Array.isArray(index)) {\n    nextTick(() => {\n      closeMenu(index.at(-1)!)\n      if (index.length > 1) {\n        closeMenu(index.slice(0, -1))\n      }\n    })\n    return\n  }\n  Object.keys(subMenus.value).forEach((item) => {\n    if (subMenus.value[item].indexPath.includes(index)) {\n      openedMenus.value = openedMenus.value.filter(item => item !== index)\n    }\n  })\n}\n\nfunction setSubMenusActive(index: string) {\n  for (const key in subMenus.value) {\n    subMenus.value[key].active = false\n  }\n  subMenus.value[index]?.indexPath.forEach((idx) => {\n    subMenus.value[idx].active = true\n  })\n  items.value[index]?.indexPath.forEach((idx) => {\n    subMenus.value[idx].active = true\n  })\n}\n\nconst handleMenuItemClick: MenuInjection['handleMenuItemClick'] = (index) => {\n  if (props.mode === 'horizontal' || props.collapse) {\n    openedMenus.value = []\n  }\n  setSubMenusActive(index)\n}\nconst handleSubMenuClick: MenuInjection['handleSubMenuClick'] = (index, indexPath) => {\n  if (openedMenus.value.includes(index)) {\n    closeMenu(index)\n  }\n  else {\n    openMenu(index, indexPath)\n  }\n}\n\nfunction initMenu() {\n  const activeItem = activeIndex.value && items.value[activeIndex.value]\n  setSubMenusActive(activeIndex.value)\n  if (!activeItem || isMenuPopup.value || props.collapse) {\n    return\n  }\n  // 展开该菜单项的路径上所有子菜单\n  activeItem.indexPath.forEach((index) => {\n    const subMenu = subMenus.value[index]\n    subMenu && openMenu(index, subMenu.indexPath)\n  })\n}\n\nwatch(() => props.menu, (val) => {\n  initItems(val)\n  initMenu()\n}, {\n  deep: true,\n  immediate: true,\n})\n\nwatch(() => props.value, (currentValue) => {\n  if (!items.value[currentValue]) {\n    activeIndex.value = ''\n  }\n  const item = items.value[currentValue] || (activeIndex.value && items.value[activeIndex.value]) || items.value[props.value]\n  if (item) {\n    activeIndex.value = item.index\n  }\n  else {\n    activeIndex.value = currentValue\n  }\n  initMenu()\n})\n\nwatch(() => props.collapse, (value) => {\n  if (value) {\n    openedMenus.value = []\n  }\n  else {\n    openedMenus.value = props.alwaysOpeneds.slice(0)\n  }\n  initMenu()\n})\n\nprovide(rootMenuInjectionKey, reactive({\n  props,\n  items,\n  subMenus,\n  activeIndex,\n  openedMenus,\n  alwaysOpenedsMenus,\n  mouseInMenu,\n  isMenuPopup,\n  openMenu,\n  closeMenu,\n  handleMenuItemClick,\n  handleSubMenuClick,\n}))\n</script>\n\n<template>\n  <div\n    class=\"h-full w-full flex flex-col of-hidden transition-all\" :class=\"{\n      'flex-row! w-auto!': isMenuPopup && props.mode === 'horizontal',\n      'py-1': props.mode === 'vertical',\n    }\"\n  >\n    <template v-for=\"item in menu\" :key=\"item.path ?? JSON.stringify(item)\">\n      <template v-if=\"item.meta?.menu !== false\">\n        <SubMenu v-if=\"item.children?.length\" :menu=\"item\" :unique-key=\"[item.path ?? (item.children.every(item => item.meta?.menu === false) ? item.children[0].path! : JSON.stringify(item))]\" />\n        <Item v-else :item=\"item\" :unique-key=\"[item.path ?? (item.children?.every(item => item.meta?.menu === false) ? item.children[0].path! : JSON.stringify(item))]\" @click=\"handleMenuItemClick(item.path ?? (item.children?.every(item => item.meta?.menu === false) ? item.children[0].path! : JSON.stringify(item)))\" />\n      </template>\n    </template>\n  </div>\n</template>\n"],"names":["props","__props","activeIndex","ref","items","subMenus","openedMenus","alwaysOpenedsMenus","mouseInMenu","isMenuPopup","computed","initItems","menu","parentPaths","item","index","indexPath","openMenu","key","closeMenu","nextTick","setSubMenusActive","_a","idx","_b","handleMenuItemClick","handleSubMenuClick","initMenu","activeItem","subMenu","watch","val","currentValue","value","provide","rootMenuInjectionKey","reactive"],"mappings":"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"}